@using HSMServer.Model.Dashboards

@model DatasourceViewModel

@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers


<li id='source_@Model.Id' class="d-flex flex-wrap list-group-item my-1 align-items-center justify-content-between border-top-1 rounded-1">
    <div class="d-flex flex-grow-1">
        <div class="d-flex flex-column" style="flex-grow: 10">
            <div class="d-flex mx-1 align-items-center">
                <label class="me-1">Label:</label>
                <input id='name_input_@Model.Id' class="form-control" asp-for="Label" type="text" oninput="javascript:realtimeUpdate('@Model.Id', '@Model.SensorId')" />

                <label class="ms-2 me-1">Property:</label>
                <select id="property_@Model.Id" class="form-select w-auto" title="Property to output" asp-for="Property" asp-items="@Model.AvailableProperties" onchange="javascript:realtimeUpdate('@Model.Id', '@Model.SensorId')"></select>

                <input id='color_@Model.Id' type="color" asp-for="Color" class="form-control form-control-color mx-1" oninput="javascript:realtimeUpdate('@Model.Id', '@Model.SensorId')" />
            </div>
            <div class="d-flex align-items-center">
                <span class="ms-1" style="color: grey;font-size: x-small;text-decoration-line: underline;cursor: pointer;" onclick="javascript:redirectToHome('@Model.SensorId')">
                    @Model.Path
                </span>
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <button class="btn" type="button" style="color: red" onclick="javascript:deletePlot('@Model.SensorId')">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>
</li>


<script>
    function realtimeUpdate(id, sensorId) {
        updateSource($(`#name_input_${id}`).val(), $(`#color_${id}`).val(), $(`#property_${id}`).val(), sensorId);
    }

    function deletePlot(sensorId) {
        let model = getCurrentPlotInDashboard(sensorId)

        if (model !== undefined) {
            $.ajax({
                type: 'delete',
                url: window.location.pathname + '/' + sensorId
            }).done(function (response) {
                Plotly.deleteTraces('multichart', model.id).then(
                    (data) => {
                        if (data.data.length === 0) {
                            Plotly.relayout('multichart', { 'xaxis.visible': false, 'yaxis.visible': false });
                            $('#emptypanel').show();
                        }

                        $('[id^="source"] li')[model.id].remove();
                        updateCurrentPlotsIds(model.id, sensorId);
                    }
                )
            }).fail(function (response) {
                showToast(response.responseText);
            });
        }
    }
</script>
